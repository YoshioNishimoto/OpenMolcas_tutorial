# 多配置SCF計算

多配置（multi(-)configuration(al)）SCF（MCSCF）計算をやります。
これまでの手法は、単一のスレーター行列式を使ってのSCF計算（Hartree–Fock法）、
あるいはその結果を用いた電子相関（やプロパティ計算）を取り扱ってきました。
すなわち波動関数$`\Psi`$をスレーター行列式$`\Phi_I`$を用いて
```math
| \Psi^\mathrm{HF} \rangle = | \Phi_1 \rangle
```
などとして計算します。
ここで$`\Phi_1`$は、一番目のスレーター行列式で、基本的には閉殻一重項基底状態に対応する電子配置です。
一方、MCSCFでは複数のスレーター行列式を用いて波動関数を定義します。
```math
|\Psi_\gamma^\mathrm{MCSCF} \rangle = \sum_I^{N_\mathrm{det}} c_{I,\gamma} |\Phi_I \rangle
```
ここで$`\gamma`$は状態（基底状態や励起状態）を指定します。
また、$`N_\mathrm{det}`$は行列式の数で、$`S_\mathrm{z} = 0`$で$`n`$個の分子軌道に$`2k`$個の電子を詰める場合、$`N_\mathrm{det} = ({}_n\mathrm{C}_k)^2`$となります。
$`c_{I,\gamma}`$はconfiguration interaction (CI)係数とも呼ばれており、$`\gamma`$番目の状態の波動関数を記述するとき、どのようにスレーター行列式を線形結合するかを決める係数となります。
なお、OpenMolcasではモジュールによってスレーター行列式ではなく配置状態関数（configuration state function; CSF）を用いる場合もありますが、特に区別せずスレーター行列式とします。
スレーター行列式は必ずしもスピン演算子に対して固有関数となるわけではありませんが、配置状態関数は固有関数となる基底を用意して計算します。

MCSCFの波動関数を定義するのに必要なパラメータは、$`c_{\gamma,I}`$だけではありません。
スレーター行列式は占有分子軌道を用いて定義するため、分子軌道を得なければなりません。
分子軌道$`\psi_p(\mathbf{r})`$は原子軌道$`\chi_\mu(\mathbf{r})`$
```math
\psi_p(\mathbf{r}) = \sum_\mu \chi_\mu(\mathbf{r}) C_{\mu p}
```
などと、分子軌道係数$`C_{\mu p}`$を用いて原子軌道の線形結合で書かれます。
結果として、Hartree–Fock法の場合は波動関数パラメータとして分子軌道係数$`C_{\mu p}`$だけ（？）でしたが、
MCSCFの場合は加えてCI係数$`c_{\gamma,I}`$も必要となります。
最適化するパラメータが増えるため、SCFの収束が難しくなりますし、実装（プログラム）も複雑になります。

プログラム的な複雑さを別にしても、計算を行う上での複雑さとしては、まず入力ファイルの作成が面倒になります。
Hartree–Fock法の場合は何も指定しなくても閉殻一重項の電子配置を使うようになるわけですが、
MCSCFの場合はどのようなスレーター行列式を含めるかを指定する必要があります。
あまり多くのスレーター行列式を計算に含めると、計算時間・メモリが多くなってしまいます。
一方、計算に含めるスレーター行列式があまり正しくない（下記の「活性空間」の取り方が良くない）と、
SCF計算が収束しなかったりします。

複数のスレーター行列式を含める計算を一般的にMCSCFと呼びます。
本来的に計算に用いるスレーター行列式を手作業で入力するものだと思われます。
ですが、最近はその特殊な形である[complete active space SCF (CASSCF)](https://en.wikipedia.org/wiki/Multi-configurational_self-consistent_field#Complete_Active_Space_SCF)という手法が用いられることが多いです。
この手法は、[活性空間（active space）](https://ja.wikipedia.org/wiki/%E5%AE%8C%E5%85%A8%E6%B4%BB%E6%80%A7%E7%A9%BA%E9%96%93)と呼ばれる分子軌道と電子から構成される「空間」をユーザーが指定すると、
プログラムが勝手にその空間でのfull CIに対応するスレーター行列式を生成し、
その行列式全てを用いてMCSCF計算を行うというものです。
すると、Hartree–Fock法の場合は分子軌道を二電子の占有軌道と非占有軌道の二つのスペースに分ければ良かったのですが、
MCSCF (CASSCF)の場合は、二電子の占有軌道と非占有軌道、そして電子占有数が小数となる（full CI計算を行う）活性空間の三つのスペースに分けることとなります。
なお、必ずしも活性空間内でfull CIを行わなければならないわけではないです。
活性空間内（すべての軌道と電子）でfull CIを行わない方法は次回扱う予定です。

<img src="https://github.com/YoshioNishimoto/sandbox/blob/figure/MCSCF_1.png" width="1024">

活性空間は、その空間に含まれる電子と分子軌道の数を指定します。
例えば、8電子6軌道のCASSCF計算は、CASSCF(8e,6o)やCASSCF(8,6)と書かれたりします（"SCF"を省略する場合もあります）。
部分空間とは言えfull CI計算をするので、電子と分子軌道の数が増えると計算コストが急激に増加します。
目安としては、(12e,12o)以上は結構時間がかかります。

では「どう活性空間を選べば良いか」ですが、よくわかりません。分子により異なります。
「多配置性が出そうな分子軌道」や「計算したい物性に関係する分子軌道」を選ぶというのが答えになると思います。
例えば芳香族系ならπ軌道とπ*軌道、第一遷移金属系ならd軌道を含めるという雰囲気です。
これまで用いてきた手法は特に手法や対象とする分子についての知識はさほど必要なく、ブラックボックス的に取り扱うことができました。
しかしMCSCFの計算は、上記の理由からブラックボックス的に取り扱うことはできず、注意深く取り扱う必要があります。
特に、どのような計算をしたいかはあらかじめ把握しておかなければなりません。
例えば結合解離を記述したいのであれば、その結合に関与するσ軌道（・π軌道）とそれらの反結合性軌道を活性空間に含めるのが基本です。
n → π\*の励起状態を計算したい場合には、関係するnとπ\*軌道（基本的にはπ軌道も）を活性空間に含めなければなりません。
しかし一方で、含める分子軌道と電子が多すぎると、計算コストが高くなりすぎてしまうので、上手に活性空間をする必要があります。

アルゴリズム的には、毎SCFサイクルで分子軌道係数の最適化とCASCI計算を行っています。
CASCI（complete active space configuration interaction）は、与えられた分子軌道係数を用いてCAS空間でfull CIを行う（CI係数の最適化）ことに対応します。
一方CASSCFは、分子軌道係数の最適化とCI係数の最適化を平行（交互に行うか同時に行うかはアルゴリズムによる。と思う）して行っています。
CASSCFでは分子軌道係数の最適化も行うため、CASCIよりもCASSCFのエネルギーが低くなります。
CASSCFで収束させた分子軌道を用いてCASCI計算を行った場合は、二つのエネルギーが一致します。

## CASSCF計算

ethyleneを使って活性空間として2電子・2軌道を用いたCASSCF、すなわちCASSCF(2e,2o)の計算してみます。
このとき、活性空間にπ軌道とπ\*軌道を使いましょう。
以下がおそらくミニマムなインプットになると思います。
```
&GATEWAY
  Coord
  6
  ethylene
  C1              -0.658467        0.000000        0.000000
  C2               0.658467        0.000000        0.000000
  H3              -1.225694        0.914334        0.000000
  H4              -1.225694       -0.914334        0.000000
  H5               1.225694        0.914334        0.000000
  H6               1.225694       -0.914334        0.000000
  Basis = 6-31G*
  Group = C1
  RICD

&SEWARD

&SCF

&RASSCF
  Inactive = 7 
  RAS2   = 2 
  nActEl = 2 0 0 
```
最初にHartree–Fock法の計算（`&SCF`）をします。
これは分子軌道係数を得るためです。
その後、CASSCFの計算（`&RASSCF`）をします。
CASSCFなのになぜ`&RASSCF`なのかと疑問に思うかもしれませんが、RASSCFという手法がより一般的なMCSCF計算をすることができるため、
このモジュールを使ってCASSCFの計算をするというだけのことです。

- `Inactive`というのは、どのスレーター行列式でも二電子占有にする分子軌道の数です。
ethyleneはHartree–Fock法での計算から8つの軌道が占有されると分かります。
CASSCF(2e,2o)の計算をしたい場合は、まず活性空間に2電子含まれていることから、Hartree–Fock法で占有軌道から1つの軌道を活性空間に入れてやります。
すると、分子軌道エネルギーが低い方から7つの軌道は二電子占有となります。
このため`Inactive = 7`となります。
- `RAS2`は活性空間でfull CIに用いる分子軌道の数を指定します。
ここではCAS(2e,2o)という活性空間を用いますから、`RAS2 = 2`となります。
なぜ「RAS2」という名前なのかは、RASSCFを行うときに分かると思います。
このとき、2つの分子軌道というのは、7つの二電子占有された軌道の次（8番目）とその次（9番目）であり、Hartree–Fock法でのHOMOとLUMOに対応します。
- `nActEl = 2`というのは、活性空間の電子数なので、2となります。

本来、活性空間を選択する際には、Hartree–Fock法の計算をしたあとで分子軌道をチェックして、
必要があれば分子軌道の順番を入れ替えてやる必要があります。
活性空間の内外での分子軌道の回転（入れ替え）はSCF内である程度行ってくれますが、
初期の分子軌道の選択によって収束のはやさは大きく異なりますし、結果は割とバラバラです。
予期しない結果に収束する場合も予期した結果に収束する場合もあります。
このため、Hartree–Fock法の計算をしたあとで分子軌道をチェックするのはもちろんのこと、
CASSCFの計算をしたあとでも（自然）軌道をチェックしなければなりません。
ちなみに、ethyleneの場合はHartree–Fock法の結果HOMOとLUMOはそれぞれπ軌道とπ*軌道であることが分かっているので、
軌道をチェックしたり入れ替えたりすることなく計算しています。

出力としては、まずは次のあたりを確認しておきましょう。
```
++    Wave function specifications:
      -----------------------------

      Number of closed shell electrons          14
      Number of electrons in active shells       2
      Max number of holes in RAS1 space          0
      Max nr of electrons in RAS3 space          0
      Number of inactive orbitals                7
      Number of active orbitals                  2
      Number of secondary orbitals              29
      Spin quantum number                      0.0
      State symmetry                             1
--

++    Orbital specifications:
      -----------------------

      Symmetry species                           1
                                                 a
      Frozen orbitals                            0
      Inactive orbitals                          7
      Active orbitals                            2
      RAS1 orbitals                              0
      RAS2 orbitals                              2
      RAS3 orbitals                              0
      Secondary orbitals                        29
      Deleted orbitals                           0
      Number of basis functions                 38
```

- `Number of electrons in active shells`は活性空間に含まれる電子の数なので、`nActEl`と一致するはずです。
- `Number of inactive orbitals`は二電子占有となる軌道の数で、`Inactive`と一致するはずです。
- `Number of active orbitals`は活性軌道の数なので、CASSCFの場合は`RAS2`と一致するはずです。
- `Number of secondary orbitals`はどのスレーター行列式でも占有されない軌道の数です。
- `Spin quantum number`は全スピン角運動量$`S`$のことです。
- `Orbital specifications`以降はほとんど同じなので説明は省略。

SCFの様子は特に説明することがないので省略。
SCF後は次のようなものが見えると思います。

```
      ************************************************************************************************************************
                                                      Wave function printout:
                       occupation of active orbitals, and spin coupling of open shells (u,d: Spin up or down)
      ************************************************************************************************************************

      Note: transformation to natural orbitals
      has been made, which may change the order of the CSFs.

      printout of CI-coefficients larger than  0.05 for root  1
      energy=     -78.059540
      conf/sym  11     Coeff  Weight
             1  20   0.97855 0.95755
             3  02  -0.20603 0.04245

      Natural orbitals and occupation numbers for root  1
      sym 1:   1.915106   0.084894
```

これは、それぞれの状態$`\gamma`$に対してのエネルギー（`-78.059540`。原子単位）、どのスレーター行列式$`\Phi_I`$が寄与しているかや、線形結合の係数$`c_{I,\gamma}`$が表示されています。
`1  20   0.97855 0.95755`の行を見ると
- `20`は活性空間での電子配置
- `0.97855`はCI係数
- `0.95755`は重み（CI係数の二乗）
が分かるようになっています。
活性空間で`20`というのは、Hartree–Fock法でHOMOが二電子占有され、LUMOが占有されないというものですから、もとから二電子占有となっている軌道も含めて考えると
閉殻一重項基底状態の電子配置に対応します。
一方、`02`というのは、閉殻一重項基底状態の電子配置から$`(\mathrm{HOMO})^2(\mathrm{LUMO})^0 \rightarrow (\mathrm{HOMO})^0(\mathrm{LUMO})^2`$なる
励起をした電子配置に対応します。
すなわち二電子励起した電子配置です。
CASSCFの基底状態は、基本的には閉殻一重項基底状態の電子配置ですが、4%ほど二電子励起状態が含まれているとのことです。
電子配置を見て分かるとおり、この一重項は当然$`S_\mathrm{z} = 0`$です。
ここでは出てきませんが、電子配置のところで`u`や`d`が出てくる場合があります。
これらはそれぞれ上向きスピン・下向きスピンの電子を意味します。

`Natural orbitals and occupation numbers`は自然軌道とその占有数です。
一般的な分子軌道はフォック行列を対角化することにより得ますが、自然軌道は一電子密度行列を対角化することにより得ます。
このときの固有値は占有数に対応します。
上述のとおり二電子励起した電子配置を含む状態なので、もともとLUMOだった軌道が少しだけ電子が占有されることとなります。
一般的には占有数が0.02から1.98になるように活性空間を選ぶと良いですよと言われています。
もちろん、いろいろな都合があるのでそこまで気にしていられませんが。

あとはHartree–Fockの計算と同じで特に説明は必要ない思うので省略。
なお、`Molecular orbitals:`のところで、活性空間の軌道でエネルギー準位が表示されているのは単なるバグです。
2023年頃から無意味な値が表示されるようになったので、注意。[^1]
このとき、軌道[^2]は`$Project.rasscf.molden`というMOLDENファイルを用いて可視化することができます。
可視化ソフトウェアを用いて、正しく軌道を用いて活性空間を定義できているか確認しましょう。

## 活性空間の指定

では、次の`&GATEWAY`を使ってbenzeneでCASSCF(6e,6o)の計算をしてみましょう。
活性空間は3つのπ軌道と3つのπ\*軌道を含めましょう。
で計算を使ってやってみましょう。

```
&GATEWAY
  Coord
  12  
  symmetry d6h 
  C        0.000000000     -1.396328944      0.000000000
  C       -1.209256337     -0.698164472      0.000000000
  C        1.209256337     -0.698164472      0.000000000
  H       -2.150060743     -1.241338149      0.000000000
  H        2.150060743     -1.241338149      0.000000000
  C       -1.209256337      0.698164472      0.000000000
  C        1.209256337      0.698164472      0.000000000
  H       -2.150060743      1.241338149      0.000000000
  H        2.150060743      1.241338149      0.000000000
  C        0.000000000      1.396328944      0.000000000
  H        0.000000000      2.482676297      0.000000000
  H        0.000000000     -2.482676297      0.000000000
  Basis = 6-31G*
  Group = C1
  RICD
```

活性空間はどう定義すれば良いでしょうか。
正しい「電子と分子軌道の数」を用いて計算すると、おそらく`energy=    -230.762484`を得られると思われます。
可視化ソフトウェアを用いて、活性空間の軌道をチェックすると、望まれる軌道になっていないと思います。
さらに正しい「活性空間」を定義して計算すると、おそらく`energy=    -230.775671`になると思われます。
CASSCFは変分的な方法なので、計算条件が同じであれば、よりエネルギーが低くなる『正しい「活性空間」』を用いた計算が正しい（それが着目したい物理量にふさわしいかは別）です。
活性空間の定義には電子と分子軌道の数が必要と述べましたが、実はどの軌道を活性空間に入れるかを追加で考慮する必要があります。

前述の通り、CASSCFを始める際に、活性空間内の分子軌道をチェックしなければなりません。
チェックした上で、活性空間に対応する番号の軌道に、活性空間に入れたいと考えている軌道（ここではπ軌道とπ\*軌道）を置かなければなりません。
それをするオプションが`&RASSCF`内の`Alter`というオプションです。
ここでは二つの軌道の順番を入れ替える必要がありますので、次のような感じにします。
`XX`と`YY`はHartree–Fock法で得た軌道の、それぞれ節がゼロと3つの分子軌道の番号です。
軌道を可視化して、正しい番号にしましょう。
```
  Alter  = 2 
           1 XX 19
           1 24 YY
```
`Alter`の直後の引数は、軌道の回転（入れ替え）をする個数です。今回は2つです。
`1 XX 19`というのは、1番目の対称性のブロックで、XX番目の軌道と19番目の軌道を入れ替えると意味です。
`1 24 YY`も同様です。
正しく入れ替えをして、`energy=    -230.775671`を得られるようにしましょう。
得た後は、やはり軌道を可視化して、教科書通りの軌道が得られているかをチェックしましょう。

## 状態平均CASSCF

上の計算は基底状態のみを取り扱う単状態（single-stateまたはstate-specific）でのCASSCF（SS-CASSCF）というものです。
このセクションでは状態平均（state-averaged） CASSCF (SA-CASSCF)をやります。
どういうときにSA-CASSCFが必要かと言われると難しいですが、励起状態を考える場合には通常SA-CASSCFにするものかと思います。
というのも、SS-CASSCFで励起状態を計算すると、root-flippingという問題が起きSCFが収束しづらくなります。
また、励起エネルギーを計算する場合には基底状態のみならず励起状態でも波動関数パラメータを最適化するべきなので、SA-CASSCFを選択するべきかと思われます。
S<sub>1</sub>まで考える場合は、多くの場合二状態の平均を取ります（が、他の励起状態やPESの扱い方に応じて変化します）。

とりあえず、上のベンゼンの計算が終わった軌道を初期軌道として、二状態を平均した計算をしてみましょう。
私は論文ではSA2-CASSCF(6e,6o)と書いたりしますが、このあたりは各人の好みでしょう。
```
(benzene_SA2.inputというタイトルをつけたいけれど、付け方が分からない）

&GATEWAY
（省略）

&SEWARD

> COPY $CurrDir/benzene.RasOrb INPORB

&RASSCF
  Inactive = 18
  RAS2   = 6 
  nActEl = 6 0 0 
  CIRoot = 2 4 1 
  LUMORB
```
`CIRoot`を新しく追加しました。
- 一つ目の値（NROOTS）は状態平均をする状態の数です。
- 二つ目の値（LROOTS）はDavidsonアルゴリズムにより得るCI解の数です。
- 三つ目の値(IALL)は状態平均の重みに関する値ですが、一般的には1で良いです。他の場合はマニュアル参照。
ここでは、Davidson iterationを5つの状態について解き、二状態平均をしたことに対応します。
LROOTS > NROOTSでなければいけません。
エネルギーに直接関係するのはNROOTSの値です。例えば`CIRoot = 2 2 1`にしても状態平均エネルギーやS<sub>0</sub>とS<sub>1</sub>のエネルギーが変わらないことを確認しましょう。

`LUMORB`は`INPORB`というファイルから軌道を読み込むオプションです。
EMILコマンド（`> COPY $CurrDir/benzene.RasOrb INPORB`）を使って、前にSS-CASSCFの計算をして得た軌道（`benzene.RasOrb）を`INPORB`としてコピーして、
その軌道を初期軌道としてSA2-CASSCF計算をするといった次第です。
過去に収束した軌道を使える場合は、極力使うようにしましょう。

## 構造最適化について

OpenMolcasはSS-CASSCF、SA-CASSCFを使って構造最適化をすることができます。
SS-CASSCFの場合は特に何も気にせず、[構造最適化](03_geomopt.md)のときと同じようにEMILコマンドや`&SLAPAF`を追加すれば良いのですが、
SA-CASSCFの場合は構造最適化に用いる状態を指定しなければなりません。
例えば、上のベンゼンのSA2-CASSCF(6e,6o)で、基底状態の構造最適化をしたい場合はさらに
```
&GATEWAY
（省略）

> Do While

&SEWARD

> if (iter == 1)
> COPY $CurrDir/bbb.RasOrb INPORB
> end if

&RASSCF
  Inactive = 18
  RAS2   = 6 
  nActEl = 6 0 0 
  CIRoot = 2 2 1 
  LUMORB
  RlxRoot = 1 

&SLAPAF

> End Do
```
のような感じで、`RlxRoot`というオプションを追加します。
これはCASSCF計算の一番目の（一番エネルギーが低い）状態を使って構造最適化するという意味です。
すなわちこれはS<sub>0</sub>です。
S<sub>1</sub>を使って構造最適化をする場合は`RlxRoot = 2`にしなければいけません。

SA-CASSCFの構造最適化を行う際に、新しく`&MCLR`というモジュールが（自動的に）呼ばれていて、繰り返し計算をしています。
ここで解いている方程式はZ-vector方程式と呼ばれているのですが、ムダに長くなるので興味がある場合は調べてみましょう。[^3]

## 演習問題

- SA2-CASSCF(2e,2o)を用いてethyleneの吸収・蛍光の波長を計算してみましょう。
- [分子軌道の可視化](04_visualization.md)で取り扱った、1,3-butadiene (C<sub>4</sub>H<sub>6</sub>)と1,3,5-hexatriene (C<sub>6</sub>H<sub>8</sub>)でも同様に垂直励起エネルギーの計算を行ってみましょう。CASSCFの計算後に出てくる、natural orbital（とoccupation number）も示してください。
ただし、当然異なる活性空間を定義する必要があるため、きちんと軌道を見ながら定義しましょう。
<!--- CASSCFのsize-extensivity（[単参照電子相関理論](07_SR_corr.md)の演習問題を参照）を検証してみましょう。CASSCFはsize-extensiveな手法です。計算条件は自分で設定してください。ただし、多配置性がほとんどでない系はやめましょう（活性空間の定義も難しくなる）。一般的には、HOMO--LUMOギャップが大きな分子は多配置性が出にくいです。-->
- 2-methylpyrimidineの第一励起はn-π*励起になった記憶があります。
どのように活性空間を設定すると、この状態を正しく記述できそうでしょうか。
活性空間に入れるべき分子軌道（できればCASSCF計算が収束した後のnatural orbital）を示しましょう。
- ethyleneのC–C間距離を100 Angstrom程度に引き延ばしたとき、size-extensiveになるような計算条件を見つけましょう。
  - ethyleneの計算で、どのように活性空間を定義するのが良いでしょうか。
  - CH<sub>2</sub>の計算で、どのように活性区間を定義するのが良いでしょうか。必要に応じてスピン量子数を変更してみましょう（マニュアル参照）。
  - このとき、CASSCF法のsize-extensive（あるいはsize-consistent）になるでしょうか。
- O<sub>3</sub>の基底状態の構造を得てみましょう。実験値は、結合長が1.2717 Angstrom、結合角が116.47°とのことです。[^4]
---

[^1]: 他の研究者から、元に戻すように言われているにもかかわらず戻っていない。自分の手元の普段使いはゼロになるように直しています。`rasscf/neworb_rasscf.f`で`FDIAG(NO1+NT)=FP(II+NFO+NIO+NFI_+ISTFCK)`を`FDIAG(NO1+NT)=0.0d+00`にする。
[^2]: おそらくinactiveとsecondaryはquasi-canonical orbital（inactiveとsecondaryで別個に対角化をするため、それぞれの空間内ではcanonical orbitalですが、全体としてはcanonical orbitalではない）ですが、activeはnatural orbital。
[^3]: J. Stålring, A. Bernhardsson, and R. Lindh, “Analytical gradients of a state average MCSCF state and a state average diagnostic,” [Mol. Phys.](https://doi.org/10.1080/002689700110005642) 99, 103–114 (2001).
[^4]: A. Barbe, C. Secroun, and P. Jouve, “Infrared spectra of <sup>16</sup>O<sub>3</sub> and <sup>18</sup>O<sub>3</sub>: Darling and Dennison resonance and anharmonic potential function of ozone,” 
[J. Mol. Spectrosc.](https://doi.org/10.1016/0022-2852(74)90267-7) 49, 171–182 (1974).
