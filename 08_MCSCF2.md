# 制限活性空間を用いたSCF/PT2計算

以前[多配置SCF計算](06_MCSCF1.md)をしました。
これは、$`\gamma`$は状態（基底状態や励起状態）の波動関数$`\Psi_\gamma`$をスレーター行列式$`\Phi_I`$を用いて
```math
|\Psi_\gamma^\mathrm{MCSCF} \rangle = \sum_I^{N_\mathrm{det}} c_{I,\gamma} |\Phi_I \rangle
```
などと、複数のスレーター行列式の線形結合として波動関数を表現しました。
このとき、どのようなスレーター行列式を考慮するかが問題で、
[多配置SCF計算](06_MCSCF1.md)のときは、
[活性空間（active space）](https://ja.wikipedia.org/wiki/%E5%AE%8C%E5%85%A8%E6%B4%BB%E6%80%A7%E7%A9%BA%E9%96%93)と呼ばれる
分子軌道と電子から構成される「空間」をユーザーが指定して、
この空間でfull CIを行いスレーター行列式を生成するというものでした。
しかし、full CIを行うということは分子軌道と電子の数を気軽に増やすことはできません。
特に点群$`C_1`$での計算だと、12電子12軌道（CAS(12e,12o)）の計算でも、かなり時間がかかったと思います。

そのようなわけで、より大きな活性空間を扱いつつも、スレーター行列式の数を減らす方法が望ましいです。
そこで、制限活性空間（restricted active space; RAS）という方法を用います。
この方法は、まず活性空間をRAS1、RAS2、RAS3という三つの空間に分割します。
そして、RAS2内ではCASと同様にfull CIの計算を行います。
一方、RAS1とRAS3はそれぞれ主に二電子占有とゼロ電子占有される空間となりますが、
励起する・励起される電子の数を制限します。
CAS空間ではすべての分子軌道と電子を用いてfull CIを行いますが、
RAS空間では励起する電子の数を制限した上で、より小さなRAS2空間のみでfull CIを行います。

<img src="https://github.com/YoshioNishimoto/sandbox/blob/figure/CAS_vs_RAS.png" width="1024">

一般的には多配置性に寄与しやすいのはフロンティア軌道付近なので、
このあたりの分子軌道と電子をRAS2に含めたいところです。
一方、励起する・されることによりエネルギーが大きく増加しやすい分子軌道に入っている電子はあまり重要でない（はず）なので、
それらをRAS1やRAS3に含めるというのは、理にかなっているのかもしれません。
一見便利に見えますが、（私が認識している限り）次のような問題があります。

- 分子軌道と電子の数が多くなるので活性空間を作るのが面倒
- SCFが収束しづらい
- truncated CIに対応するため、CASSCFとは違いsize-extensiveではなくなる
- 同程度の数のスレーター行列式を用いるなら、CASSCFの方が精度が良く、高速
- 調子の乗るとスレーター行列式の数が多くなるので、結局大して大きな活性空間にできない

しかしながら、RAS1とRAS3の寄与は小さい、けれど活性空間に入れておきたいという場合はありますので、そのような時に便利です。
例えば、金属部分はCASにしたいけれど、リガンド部分はCASに入れるほどではないとか（？）。

表記の方法に関しては、RAS(<i>n</i>,<i>l</i>,<i>m</i>;<i>i</i>,<i>j</i>,<i>k</i>)という表記をご紹介しておきます。
- <i>n</i>は活性空間の電子数
- <i>l</i>はRAS1空間から励起する最大の電子数
- <i>m</i>はRAS3空間へ励起する最大の電子数

これは、インプットファイルでは`NACTEL = n l m`というオプションに対応します。

- <i>i</i>はRAS1の分子軌道の数
- <i>j</i>はRAS2の分子軌道の数
- <i>k</i>はRAS3の分子軌道の数

これらのオプションは、それぞれ`RAS1`、`RAS2`、`RAS3`に対応します。
そのようなわけで、上の図の場合は
```
&RASSCF
  NACTEL = 6, 2, 2
  RAS1 = 2
  RAS2 = 2
  RAS3 = 2
```
というオプションを入力することとなります。
`INACTIVE`は、CASの場合と同様で、上の図の場合は3となります。
対称性を用いる場合は、`RAS1`、`RAS2`、`RAS3`は既約表現ごとに軌道の数を入れることとなりますが、
`NACTEL`はCASの場合と同様に、活性空間全体の数を入れることとなります。

なお、RAS2以外すべての二電子占有軌道をRAS1に入れ、すべての非占有軌道をRAS3に入れ、
励起する・される電子の最大数を2にすると、uncontracted MRCISD (multireference configuration interaction singles and doubles)に対応します。
また、Hartree–Fockで得られた分子軌道を初期の軌道として読み込ませ、RAS1と占有軌道の数、RAS2をゼロ、RAS3を仮想軌道の数にして、
さらにRAS1空間から励起する電子数・RAS3空間へ励起する電子数を2にすると、CISD (configuration interaction singles and doubles)ができます（[単参照の電子相関計算](05_correlation.md)参照）。

## CASSCF vs. RASSCF

というわけで、1,3,5-hexatrieneを使って、CASとRASで比較してみましょう。
必要なファイル（構造を初期軌道）はGitHub参照。
とりあえずCASの場合は次のような感じにしておきます。
```
&GATEWAY
  Coord = hexatriene.Opt.xyz
  Basis = cc-pVDZ
  Group = C1
  RICD

&SEWARD

> COPY $CurrDir/hexatriene.RasOrb INPORB

&RASSCF
  LUMORB
  INACTIVE = 19
  NACTEL = 6 0 0
  RAS1   = 0
  RAS2   = 6
  RAS3   = 0
```
このとき、スレーター行列式の数は210（`Number of determinants`の値参照）で、エネルギーは`-231.91133043`になると思います。

それでは、次の活性空間を用いて、CASSCFの値といくつかのRASSCFの値を比較してみましょう。
初期軌道はCASSCFで得られたものを用いるのが良いでしょう。

- RAS(6,1,1;2,2,2)
- RAS(6,1,1;1,4,1)
- RAS(6,2,2;3,0,3)
- RAS(6,2,2;2,2,2)
- RAS(6,2,2;1,4,1)
- RAS(6,4,4;2,2,2)
- RAS(6,6,6;3,0,3)

例えば、`RAS(6,1,1;2,2,2)`の場合、スレーター行列式の数は31で、エネルギーは`-231.87671475`になると思います。
計算に用いるスレーター行列式の数がかなり少ないため、エネルギーもかなり高いことが分かります。
一方、例えば`RAS(6,6,6;3,0,3)`の場合、CASSCFと同じ結果になると思います。

## 状態平均RASSCF

状態平均（state-average）の方法はCASSCFの場合と同様なので省略。

## RASPT2

CASSCF (CAS-CI)で得られた波動関数を参照して摂動的な二電子励起を考慮すると、CASPT2ができました。
同様に、RASSCF（RAS-CI）で得られた波動関数を参照すると、RASPT2と呼ばれます。
計算の方法はCASPT2と同様なので省略。

ただし、RASPT2にはいくつかの注意点があります。
一つ目は、現在の実装では、RASPT2で活性空間内の二電子励起が考慮されない点です。
CASPT2の場合はCASSCFを参照しているため、活性空間内の二電子励起を考慮する必要がありませんでした。
しかし、RASPT2の場合は、（いくつかの特殊な場合を除いて）例えばRAS1とRAS2のあいだやRAS1とRAS3のあいだでの励起を本来は考慮しなければなりません。
OpenMolcasの実装では現状できません。

もう一つは、CASと同等になるRASを用いて計算をする場合です。
SCF計算では、上のCAS(6e,6o) vs. RAS(6,6,6;3,0,3)の例から分かるとおり、
RASSCFでも活性空間内ですべての電子配置を考慮するような活性空間を定義すると、CASSCFと同じ結果が得られます。
しかし、こうして得られた波動関数を用いてRASPT2の計算をしても、CASPT2と同じ結果にはなりません。
これは、（一般化）フォック行列の対角化の方法が異なるためです。
CASPT2の場合は活性空間全体で対角化をしますが、RASPT2の場合はRAS1、RAS2、RAS3と分けて対角化をします。
このような違いから、SCF計算の結果が同じでもCASPT2とRASPT2で結果が異なる場合があります。

## 構造最適化について

RASSCFを用いた構造最適化も可能です。
方法はこれまでと同様です。
単状態のRASSCFの場合は対称性を用いることができるはずです。
しかし、SA-RASSCFやRASPT2レベルで構造最適化を行う場合は、対称性を用いることができません。

## 演習問題

- RASSCFがsize-extensiveでないことを示す方法を考え、さらに数値的にsize-extensiveでないことを示してください。
- 上のhexatrieneの例を用いて、CASPT2(6e,6o)とRASPT2(6,6,6;3,0,3)の結果を比較してみましょう。
---
