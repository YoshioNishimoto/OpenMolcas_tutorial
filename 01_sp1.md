# 一点計算（入力ファイル）

エネルギーの計算（プロパティの計算含む）を一点計算（single-point calculation）と呼びます。
「一点の構造での計算」という意味です。
そうでない計算は、例えば構造最適化計算や分子動力学シミュレーションのように、分子構造を変化させていく計算です。

量子化学計算を（まじめに）行うには、もちろん量子化学の理論を勉強しておく必要があります。
ここでの量子化学は学部で勉強する量子化学とはやや異なるかもしれません。
量子化学計算に直接関連する理論については、例年Szabo & Ostlundの教科書で勉強することとなっています。
もう一つ、量子化学の理論だけでなく、計算を行うにはプログラムの使い方を把握しておく必要があります。
量子化学計算プログラムはたくさん存在するので、使用するプログラムに応じて使い方を勉強しなければいけません。
ここではOpenMolcasの使い方ということになりますが、他のプログラムを使うときはまた異なる使い方となります。
その場合はマニュアルを参考に勉強します。
ちなみに、OpenMolcasのマニュアルは[HTML](https://molcas.gitlab.io/OpenMolcas/sphinx/)と[PDF](https://molcas.gitlab.io/OpenMolcas/Manual.pdf)が用意されています。
英語ですが。

## OpenMolcasの計算方法

[前回](00_introduction.md)で行ったとおり、OpenMolcasをインストールできて、入力ファイル（インプットファイル）を用意できたことにしておきます。
前回は`molcas-gnu_dev_omp`または`molcas-gnu_dev_ga`という実行ファイルを使って
```
$ ~/OpenMolcas/molcas-gnu_dev_omp test.input
```
によりOpenMolcasを使った計算をしました。
ちなみに、入力ファイルの拡張子はどんなものでもOKですし、なくてもOKです。
`molcas-gnu_dev_omp`の中身は
```
#!/bin/sh
export MOLCAS=/home/nisimoto/OpenMolcas/builds/gnu_dev_omp
${MOLCAS}/pymolcas $*
```
というようなものでした。
1行目はおまじない。
2行目は`MOLCAS`という環境変数を設定し、OpenMolcasをビルドしたディレクトリを指定します。
複数のビルドを置いてある環境でも、この環境変数を設定することで簡単に使い分ける[^1]ことができます（例えばGA並列のあり・なし）。
3行目が実際に計算するところです。
`pymolcas`というPythonスクリプトを用いて計算を始めるというところです。
この実行ファイルは簡単な名前をつけてパスを通しておくと良いでしょう。

他にも設定すると便利かもしれない環境変数としては
- `MOLCAS_MAXMEM`: 計算で使う最大メモリ（MB単位）（例: `export MOLCAS_MAXMEM=2000`）
- `MOLCAS_WORKDIR`: 計算の作業用ディレクトリ（例: `export MOLCAS_WORKDIR=/dev/shm`）
- `MOLCAS_KEEP_WORKDIR`: 作業用ディレクトリを削除するかどうか（例: `export MOLCAS_KEEP_WORKDIR=NO`）
あたりでしょうか。
詳細はマニュアルのセクション4.1.2.5 System variables参照。
これらの環境変数はインプットファイルでも設定できたと思います。

## インプットファイルの一般的な構造

インプットファイルには計算で使うモジュール名（例えば`&GATEWAY`や`&SEWARD`）とオプション（例えば`coord=2`や`angstrom`など）を書いていきます。
一般的には大文字と小文字は区別されません。
書きやすさや読みやすさで決めましょう。
セミコロン（`;`）を使うと改行の代わりになります。
`OpenMolcas`ディレクトリ中にある`test`というディレクトリにインプットファイルの例がたくさんあります。


モジュール名の場合は`&`から始めて計算で使うモジュール名を指定します。
このモジュール名は省略できませんので、よく使うものはマニュアルを読んで覚えましょう。
例えば`&GATEWAY`は、計算で使う分子や計算の詳細（基底関数など）を指定するモジュールです。
`&SEWARD`[^2]は一電子ハミルトニアン（電子の運動エネルギーや核–電子間相互作用）を計算するモジュールです。
この二つは、基本的にどの計算をするときでも必要になると思われます。
そして`&SCF` (self-consistent field)はHartree–Fockの計算を行うモジュールです。
他にもこのチュートリアルで少なくとも`&RASSCF`、`&CASPT2`、`&MCLR`、`&ALASKA`、`&SLAPAF`あたりは使う予定です。
なお、場合によってはモジュールが他のモジュールを自動で呼ぶ設定になっているので、省略できるモジュールもあります（`&MCLR`は省略されることが多い）。
それぞれのモジュールは`&GATEWAY &END`のように書いても構いません（別の行にはできないはず）。
また、それぞれのモジュールが終わるところで`end of input`などと書くこともできます（自分は書かない）。

それぞれのモジュールで書くことができるオプションが決まっています。
例えば`coord=2`は`&GATEWAY`用のオプションなので、`&SCF`のところに書いても意味がありません。
オプションによってはオプションを書くだけというものがあります（例えば`NoCD`）。
一方、イコールをつけて、あるいはつけずに値を書かないといけない場合もあります。
例えば`Basis = 6-31G*`というのはイコールの右辺が値ということになります。
このときイコールは省略できません[^3]。
ですが、[前回使ったファイル](00/test.input)の場合、
```
&GATEWAY
  Coord
  2
  Angstrom
  H 0.0 0.0 0.0
  H 1.0 0.0 0.0
  Basis
  6-31G*
  Group
  C1
  NoCD
```
のように、次の行に値を書く場合はイコールを省略できます。
このあたりは試行錯誤の末に覚えましょう。

## EMILコマンド

詳細はマニュアルのセクション4.1.3 (General input structure. EMIL commands)参照。
`>`で始まる行はEMILコマンドとよび、やや特殊な操作をすることができます。
こちらも大文字・小文字の区別はありません。

自分が使うEMILコマンドは固定されておりそれほど詳しくないので、使うときに紹介していきます。
使う予定のコマンドは
- `> DO WHILE`
- `> ENDDO`または`> END DO`
- `> IF (ITER = 1)`
- `> COPY`
あたりかなと思います。

## モジュールとオプションの詳細

[前回使ったファイル](00/test.input)は
```
&GATEWAY
  Coord = 2
  Angstrom
  H 0.0 0.0 0.0
  H 1.0 0.0 0.0
  Basis = 6-31G*
  Group = C1
  NoCD

&SEWARD

&SCF
```
というようなものでした。

### 原子の指定

このファイルはH<sub>2</sub>分子のエネルギーを計算します。
このとき、`Coord = 2`は原子数、`Angstrom`は原子の座標をAngstrom単位で書くことを宣言し、その次の二行で二つの水素原子をそれぞれ`0.0 0.0 0.0`と`1.0 0.0 0.0`という座標に置くことを意味します。
すなわち、H<sbu>2</sub>分子の原子間距離は1.0 Angstromです。
座標を適当に変更することにより、原子間距離を変更できます。
他の分子を計算したい場合は`Coord`の値と元素・座標を変更しましょう。
計算する分子は直接インプットファイルに書く必要はありません。
例えば`water.xyz`というXYZ形式のファイルを用意し、インプットファイルに`coord = water.xyz`のように書いて指定することができます。

### 基底関数の指定

`Basis = 6-31G*`は**基底関数**を指定しています。
基底関数が量子化学計算に導入される過程は一応Szabo: Sec.3.4.2に書いてあります。
簡単に言えば、狭義のHartree–Fock方程式（積分微分方程式）を数値的に解くのは難しいため、基底関数を導入してHartree–Fock–Roothaan方程式を解くようにしています。
こうすると、微分方程式から線形代数の問題へ変換でき、ご存じ（？）の通り、繰り返し計算を行うことで割と簡単に方程式を解くことができます。
基底関数は、原子の上に置く関数のことで、分子軌道（$`\psi_i`$）は基底関数（原子軌道）（$`\chi_\mu`$）の線形結合により表されます。
よくLCAO (linear combinations of atomic orbitals)とかいうやつですね。
```math
\displaystyle \psi_i = \sum_\mu \chi_\mu C_{\mu i}
```
(Szabo: 式(3.133))。
$` \displaystyle C_{\mu i}`$は分子軌道係数です。詳しくはSzabo: Sec.3.4.2や3.5.1をご参照ください。
量子化学の授業でも出てきた概念だと思います。
例えばヒュッケル法を用いてベンゼンの永年方程式を解くと、6つのp軌道（これが原子軌道）の組み合わせで6つのπ軌道・π*軌道（これが分子軌道）が出てくることを確認しました。
量子化学計算でも同じようなことをしていますが、p軌道だけではなくs軌道、d軌道、f軌道･･･と高次の角運動量を持つ軌道関数を用いることも少なくありません。
また、主量子数に関しても量子化学で勉強する以上の値を用いることも少なくありません（例えばC原子でも3s, 3p, 3d軌道を用いたり）。

予想されるとおり、基底関数が大きければ大きいほど（与えられた手法の中で）厳密な結果に近づいていきます。
無限に大きな基底関数を用いることができれば良いのですが、無限に計算時間が必要なため、有限の基底関数を用いる必要があります。
現実には、手元の計算リソースで用いることができる最大の基底関数を用いて研究を行っていく必要があります。
と言っても、ある程度妥協は必要ですが。

上記の例では`Basis = 6-31G*`としており、いわゆるPople系の基底関数と呼んだりしています。
水素原子の場合はs軌道を2つ（正確ではないですが1s + 2s）用いるという基底関数です。
炭素原子の場合はs軌道3つ、p軌道2つ、d軌道1つ（1s + 2s + 3s + 2p + 3p + 3d）だったと思います。
他にもcc-pVDZ (correlation consistent polarized valence double zeta)という基底関数を用いたりするかもしれません。
当面はcc-pVDZ（`ccpvdz`）、6-31G(d)/6-31G*（`6-31g(d)`）、STO-3G（`sto-3g`）あたりを用いれば良いと思います。
上に挙げた順に、用いる関数の数が減っていきます（STO-3Gが上記の最小）。
指定できる基底関数の数は非常に多く、到底ここでご紹介できるものではありません。
他の選択に興味があれば、[EMSL](https://www.basissetexchange.org/)等をご参照ください。
また、どの角運動量の関数を用いているか等も知っておくと良いでしょう（Frank Jensen: Introduction to Computational Chemistryの5章が分かりやすいのですが･･･）。

時間があれば、`basis='ccpvtz'`（cc-pVTZ基底関数）、`basis='ccpvqz'`（cc-pVQZ基底関数）を試して（計算時間が増えるので注意）みましょう。
大きな基底関数ほど、高次の角運動量の関数（f関数、g関数、...）を用いる、あるいは同じ角運動量でも多くの関数を用いていく（関数の広がり方が異なる）ようになります。

### 対称性の指定

「化学数学」で勉強したとおり、分子によっては対称性があり、対称性を利用することで計算を簡単にしたり、結果を解釈しやすくしたりすることができます。
OpenMolcasの場合はアーベル群（Abelian group）のみ使うことができます。
H<sub>2</sub>は$`D_{\inf\mathrm{h}}`$（Abelian group or not?）ですが、上記の例では$`C_1`$で計算しています。
対称性を使いたい場合は`Group = C1`のところを`Group = Full`にしてみましょう。
基本的には勝手に適切な対称性を認識して、いい具合にやってくれます。
それ以外の指定はマニュアル参照。

出力ファイル（ただし、何もしなければ標準出力（＝ターミナル）になっているはず）として、`converged SCF energy = -1.06111199785749`が得られたかと思います。
これが、H<sub>2</sub>分子の「エネルギー」を意味しています。
単位は書かれていませんが、その場合は「原子単位 (atomic unit)」あるいは「ハートリー (hartree)」であるという暗黙の了解があります。
「エネルギー」に関しては次回[一点計算（出力ファイル）](02_sp_output)のところでもう少し説明する予定です。

この入力ファイル・出力ファイルだけ見たところで、事前知識がないと分かりづらいですが、
RHF（restricted Hartree--Fock）という**手法**とcc-pVDZという**基底関数**を組み合わせて計算を行いました。
このため、ここでの計算を発表する際には、例えば「(R)HF/cc-pVDZ」の計算を行ったと表記します。
(R)が必要かは場合によるかと思います。
なので、上記エネルギーは「H<sub>2</sub>の(R)HF/cc-pVDZにおけるエネルギーは-1.06111199785749 hartree」と表現したりします。
ただし、実際に何のエネルギーを用いて議論するかや、どの程度の桁数が必要かは、議論する性質や単位によって変わります。
Hartree--Fock法についての詳細はSzabo: Chapter 3等をご参照ください。
現代ではHartree--Fock法の結果をそのまま論文等で報告することは稀ですが、
電子相関を考える際のベースとなる手法です。
現代では電子相関理論よりも[密度汎関数理論（density functional theory）](04_dft)を用いた計算の方が主流ですが。

### Cholesky decomposition

`NoCD`というのは電子反発積分（二電子積分）の計算にCholesky decompositionを使わないというオプションです。
二電子積分は原子軌道の4乗に比例して扱う数が大きくなっていくので、（近似的に）コレスキー分解をしてから保存しておくということをしています。
これにより必要なディスク容量を削減し、計算の高速化をすることができます。
コレスキー分解を使う場合は`NoCD`の代わりに`RICD`としましょう。
Hartree–Fockの場合は一般的な計算プログラムはintegral directとか言って、二電子積分を毎サイクル計算し直すということをしますが･･･。

### &SEWARD

特に説明することはないでしょう。

### &SCF

`SCF`は"self-consistent field"の事です。
日本語では「自己無撞着場（じこむどうちゃくば）」とか「自己無矛盾場（じこむむじゅんば）」とか訳されたりしますが、
逆に意味が分からないのでSCFなりself-consistent fieldなり書きましょう。
実際にはHartree–Fockの計算をしている[^4]わけですが、詳細はSzabo先生の教科書で勉強することになると思います（主にChapter 3）。
`&SCF`の中で電荷やスピン多重度を指定することができます（マニュアル参照）。

上向きスピンと下向きスピンの電子をつめる分子軌道を同じとする場合、制限(restricted) Hartree–Fock (RHF)法と呼んだりします。
スピン多重度が1の場合は**基本的に**制限Hartree–Fock法の計算を行います。
スピン多重度が1でない場合は、別々の分子軌道を用いる場合は非制限(unrestricted) Hartree–Fock (UHF)法、
同じ分子軌道を用いる場合は制限開殻(restricted open-shell) Hartree–Fock (ROHF)法と呼んだりします。
ROHFはCASSCFを使って表現できるので、OpenMolcasはROHFが扱えない？

## 演習問題

- アーベル群で最も対称性が高い点群は？H<sub>2</sub>はどの点群で計算されているでしょうか。
- H<sub>2</sub>O（H-O距離が1.0 Angstrom、H-O-Hが120度）のHF/cc-pVDZ、HF/cc-pVTZ、HF/cc-pVQZのエネルギーを計算してみましょう。
また、それぞれの「相対エネルギー」をkcal/mol単位（小数点二桁までで良い）で計算してみましょう。
計算時間を比較してみると良いかもしれません。
今回は初めての計算ということで、私が計算した結果でも。基底関数の大きさとしては、cc-pVDZ < cc-pVTZ < cc-pVQZです。

| 基底関数 | エネルギー（hartree)| 計算時間（秒）|
| ------- | ----------------- | ------------ |
| cc-pVDZ | -76.0142704701529 | 0.046        |
| cc-pVTZ | -76.0448154851462 | 0.085        |
| cc-pVQZ | -76.0525392908608 | 0.879        |

- 基底関数が大きくなると、基本的にはエネルギーが減少していきます。なぜでしょうか。
- 他の任意の分子に関しても、時間があれば同様の計算をしてみましょう。
ただし原子の数が多いと、分子構造の座標を作成するのが面倒（実際には可視化ソフトウェアを用いて分子構造を作成します）だったり、計算時間がとても長くなります。
- `&SCF`の中で電荷を指定するオプションを探してhydroxy anionの計算をしてみましょう。
- 同様にスピン多重度を指定するオプションを探してhydroxy radicalの計算をしてみましょう。

---

[^1]: 計算を行うディレクトリがOpenMolcasのインストールディレクトリより下にある場合は、`MOLCAS`の環境変数にかかわらず最後にインストールした（`make install`が必要？）OpenMolcasが使われることがあります。
[^2]: アラスカ州の都市から来ているはず。`&ALASKA`というモジュールもあり、エネルギーの微分を計算するときに使います。
[^3]: あまり使われないオプションの中には、省略して値を与えないといけないオプションもあったと思う。
[^4]: 原理主義者からすると、Hartree–Fockは完全基底系での手法であり、ここで行うような部分空間を用いる場合はあくまでSCFレベルなのだとか。
